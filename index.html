<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Калькулятор от ШАГАЙ ДОМА⚡</title>
<meta name="description" content="Узнайте, за сколько недель шагательные тренировки помогут вам похудеть."/>
<meta name="color-scheme" content="light only"/>
<link rel="preload" as="image" href="superfit.png">
<link rel="preload" as="image" href="m.png">
<link rel="preload" as="image" href="xxl.png">
<style>
:root{--r:#CF2C02;--y:#FFBA08;--o:#E85D04;--g:#D9D9D9;--txt:#1a1a1a;--hero-pos-y:28%;--hero-pos-y-m:22%}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);background:#fff;overflow-x:hidden}
.app{width:min(960px,100%);margin:0 auto;padding:16px}
.card{background:#fff;border-radius:22px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px;overflow:hidden;position:relative}

/* HERO */
.hero-wrap{position:relative;margin:0 0 12px;border-radius:20px;overflow:hidden;box-shadow:0 10px 18px rgba(0,0,0,.08)}
.hero-media{display:block;width:100%;height:auto;aspect-ratio:16/9;object-fit:cover;object-position:50% var(--hero-pos-y);border-radius:20px}
@media (max-width:480px){.hero-media{object-position:50% var(--hero-pos-y-m)}}
.hero-skel{position:absolute;inset:0;border-radius:20px;background:linear-gradient(110deg,#f4f4f4 8%,#eaeaea 18%,#f4f4f4 33%);background-size:200% 100%;animation:heroShimmer 1.2s linear infinite;pointer-events:none}
@keyframes heroShimmer{to{background-position-x:-200%}}
.hero-skel.hide{opacity:0;pointer-events:none;transition:opacity .25s ease}

/* Screens */
.screen{display:none;animation:.35s fs ease both;padding-bottom:90px}
.screen.is{display:block}
@keyframes fs{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:clamp(22px,5.6vw,38px);line-height:1.15;margin:8px 0 10px}
h2{font-size:clamp(20px,5vw,30px);line-height:1.18;margin:6px 0 12px}
.hint{color:#6b6b6b;font-size:.95rem}
.grid{display:grid;gap:10px}.cols2{grid-template-columns:1fr 1fr}
@media (max-width:620px){.cols2{grid-template-columns:1fr}}

.opt{border:2px solid var(--g);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center;background:#fff;cursor:pointer;transition:.2s}
.opt.is{border-color:var(--o);box-shadow:0 6px 16px rgba(232,93,4,.12)}
.opt--img{flex-direction:column;align-items:center;text-align:center;padding:10px}
.opt--img img{width:100%;height:180px;object-fit:contain;background:#fafafa;border-radius:12px}
.opt--img span{margin-top:8px;font-weight:600}

.chips{display:flex;flex-wrap:wrap;gap:8px}.chip{border:2px solid var(--g);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.chip.is{border-color:var(--o);box-shadow:0 6px 16px rgba(232,93,4,.12)}
.text{width:100%;border:2px solid var(--g);border-radius:12px;padding:10px 12px;font-size:1rem}

.actions{display:flex;gap:8px;margin-top:14px}
.btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.primary{background:linear-gradient(135deg,var(--r),var(--o));color:#fff;box-shadow:0 10px 18px rgba(207,44,2,.25)}
.ghost{background:#fff;border:2px solid var(--g)}
.sticky{position:sticky;bottom:0;background:linear-gradient(0deg,#fff 70%,rgba(255,255,255,0));padding-top:8px;z-index:20}

/* Progress circle + logo */
#progress{position:relative;height:auto;margin:0 0 12px;display:flex;align-items:center;gap:10px}
#progress.hide{display:none!important}
#progress .pcirc{--p:0%;width:56px;height:56px;border-radius:50%;background:conic-gradient(var(--o) var(--p),#eee 0);position:relative;display:inline-grid;place-items:center;box-shadow:0 6px 16px rgba(0,0,0,.08);transition:background .15s linear;flex:0 0 56px}
#progress .pcirc::after{content:"";width:44px;height:44px;border-radius:50%;background:#fff;position:absolute}
#progress .pct{position:relative;z-index:1;font-size:.9rem;font-weight:800;letter-spacing:-.02em}
#progress .plogo{margin-left:auto;display:flex;align-items:center;flex:0 0 auto}
#progress .plogo img{height:32px;width:auto;display:block;object-fit:contain}
@media (max-width:480px){#progress .plogo img{height:28px}}

/* Steps slider */
#steps{--pct:0%;--track:#e9e9e9;--fill-start:var(--r);--fill-end:var(--o);width:100%;height:40px;background:transparent;accent-color:var(--o)}
#steps:focus{outline:none}
#steps::-webkit-slider-runnable-track{height:12px;border-radius:999px;background:linear-gradient(90deg,var(--fill-start) 0 var(--pct),var(--track) var(--pct) 100%);box-shadow:inset 0 1px 2px rgba(0,0,0,.08)}
#steps::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;border:3px solid var(--o);box-shadow:0 4px 10px rgba(232,93,4,.25);margin-top:-8px;transition:transform .12s ease}
#steps:active::-webkit-slider-thumb{transform:scale(1.06)}
#steps::-moz-range-track{height:12px;border-radius:999px;background:#e9e9e9}
#steps::-moz-range-progress{height:12px;border-radius:999px;background:linear-gradient(135deg,var(--fill-start),var(--end))}
#steps::-moz-range-thumb{width:28px;height:28px;border-radius:50%;background:#fff;border:3px solid var(--o);box-shadow:0 4px 10px rgba(232,93,4,.25)}

/* BMI */
.bmi-line{margin-top:6px}
.bmi-tag{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:.9rem;vertical-align:baseline}
.bmi-ok{background:#e8f7ee;color:#0f7a42}.bmi-warn{background:#fff4e6;color:#a04b00}.bmi-bad{background:#ffe9e6;color:#a11000}

/* Habits */
.habit{display:grid;gap:14px}
.habit-grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
@media (max-width:720px){.habit-grid{grid-template-columns:1fr}}
.habit h3{margin:.2rem 0 .6rem;font-size:1.02rem}
.habit .col{border:2px solid var(--g);border-radius:14px;padding:12px;background:#fff}
.chips--pills{gap:8px}
.chips--pills .chip{border-radius:999px;padding:9px 12px;font-weight:600;border:2px solid var(--g);background:#fff;transition:.15s}
.chips--pills .chip.is{border-color:var(--o);background:#fffaf5}

.habit-meter{border:2px solid var(--g);border-radius:14px;padding:12px;background:#fff}
.habit-meter.hidden{display:none}
.hm-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
#hmScore{font-weight:800}
.hm-track{--p:50%;position:relative;height:12px;border-radius:999px;overflow:hidden;background:linear-gradient(90deg,#ffe1db 0%,#fff7e8 50%,#e7f7ef 100%)}
.hm-pointer{position:absolute;top:50%;left:var(--p);transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#fff;border:3px solid var(--o);box-shadow:0 3px 10px rgba(0,0,0,.12);transition:left .25s ease}
.hm-scale{display:flex;justify-content:space-between;font-size:.82rem;color:#666;margin-top:6px}
.hm-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:.85rem;margin-left:8px}
.hm-bad{background:#ffe9e6;color:#a11000}.hm-ok{background:#fff3cc;color:#9a6b00}.hm-good{background:#e7f7ef;color:#0f7a42}

/* Hard cards */
.hardw{display:grid;gap:14px}
.hard-cards{display:grid;gap:12px;grid-template-columns:1fr 1fr}
@media (max-width:760px){.hard-cards{grid-template-columns:1fr}}
.hcard{position:relative;border:2px solid var(--g);border-radius:16px;background:#fff;padding:14px;cursor:pointer;transform-style:preserve-3d;transition:transform .15s ease,box-shadow .2s ease,border-color .2s;box-shadow:0 8px 18px rgba(0,0,0,.05);overflow:hidden}
.hcard:hover{box-shadow:0 12px 26px rgba(0,0,0,.08)}
.hcard.is{border-color:var(--o);background:linear-gradient(180deg,#fff 0,#fff9f3 100%);box-shadow:0 12px 26px rgba(232,93,4,.18)}
.hhead{display:flex;gap:10px;align-items:center;letter-spacing:-.02em}
.hicon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-size:22px;background:#fff6f1;border:2px solid #ffd5c2}
.hhead,.hhead *{font-weight:500 !important}

/* Goal UI */
.goalw{display:grid;gap:12px}
.goal-top{display:grid;gap:8px;grid-template-columns:1.05fr .95fr}
@media (max-width:780px){.goal-top{grid-template-columns:1fr}}
.goal-card{border:2px solid var(--g);border-radius:16px;padding:10px;background:#fff;overflow:hidden}
.goal-fig{position:relative;height:260px;border:2px solid var(--g);border-radius:16px;padding:8px;background:#fff;overflow:hidden}
@media (max-width:480px){.goal-fig{height:220px}}
.goal-range .val{display:flex;align-items:baseline;gap:8px;font-size:clamp(18px,4.6vw,28px);font-weight:800;letter-spacing:-.03em;white-space:nowrap}
.goal-range .sub{color:#666;margin-top:2px}
#goalRange{width:100%;height:38px;background:transparent;accent-color:var(--o);--track:#e9e9e9;--fill-start:var(--r);--fill-end:var(--o)}
#goalRange:focus{outline:none}
#goalRange::-webkit-slider-runnable-track{height:12px;border-radius:999px;background:linear-gradient(90deg,var(--fill-start) 0 var(--pct),var(--track) var(--pct) 100%)}
#goalRange::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#fff;border:3px solid var(--o);box-shadow:0 4px 12px rgba(232,93,4,.25);margin-top:-7px;transition:transform .12s ease}
#goalRange::-moz-range-thumb{width:26px;height:26px;border-radius:50%;background:#fff;border:3px solid var(--o)}

/* Goal silhouettes */
.goal-stack{position:relative;width:100%;height:100%}
.goal-stack img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;opacity:0;transform:scale(1);transition:opacity .28s ease,transform .28s ease;filter:drop-shadow(0 8px 22px rgba(0,0,0,.08))}
.goal-stack .tape{display:none!important}

/* Loading/result/sale */
.loader2{display:flex;flex-direction:column;align-items:center;text-align:center;padding:28px 8px 12px}
.loader2 .ring{--p:0%;width:88px;height:88px;border-radius:50%;background:conic-gradient(var(--o) var(--p),#eee 0);position:relative;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.loader2 .ring::after{content:"";position:absolute;inset:10px;background:#fff;border-radius:50%}
.loader2 .pct{position:absolute;inset:0;display:grid;place-items:center;font-weight:800}
.loader2 .lmsg{margin-top:14px;font-weight:700;font-size:1.05rem}
.counter{font-size:clamp(26px,6vw,48px);line-height:1.15;letter-spacing:-.02em;text-wrap:balance}
.sale-hero{margin:0 0 12px;border-radius:16px;overflow:hidden}
.sale-hero img{width:100%;display:block;border-radius:16px;object-fit:cover}

/* кейс-виджет */
.case{border:2px solid var(--g);border-radius:16px;padding:12px;background:#fff;
      display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:center;margin:10px 0}
.case img{width:96px;height:96px;object-fit:cover;border-radius:12px;background:#f6f6f6;cursor:zoom-in}
.case h3{margin:0 0 4px;font-size:1.05rem}
.case p{margin:0;color:#555}
.case.hide{display:none}

/* лайтбокс */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
#lightbox.show{display:flex}
#lightbox img{max-width:96vw;max-height:90vh;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
#lightbox .cap{color:#fff;margin-top:10px;text-align:center;font-size:1rem;opacity:.9}
#lightbox .x{position:absolute;top:10px;right:14px;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:rgba(255,255,255,.12);color:#fff;font-size:26px;cursor:pointer}
#lightbox .x:active{transform:scale(.96)}

/* Program slide */
.prog-wrap{display:grid;gap:12px}
.prog-head{
  position:relative;border:2px solid var(--g);border-radius:16px;padding:14px 12px;
  background:
    radial-gradient(120% 80% at 0% 0%, rgba(255,240,230,.9), transparent 50%),
    radial-gradient(120% 80% at 100% 100%, rgba(255,247,236,.9), transparent 55%),
    linear-gradient(180deg,#fff,#fff);
  overflow:hidden;
}
.prog-head::after{
  content:""; position:absolute; right:-40px; top:-40px; width:160px; height:160px;
  background:conic-gradient(from 0deg, #FFBA08, #E85D04); opacity:.15; border-radius:50%;
  filter:blur(6px);
}
.p-title{margin:.2rem 0 6px; font-size:clamp(20px,5vw,28px); font-weight:800; letter-spacing:-.02em}
.p-sub{margin:0; color:#555}
.p-chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
.p-chip{border:2px solid #ffd5c2; background:#fff7ef; border-radius:999px; padding:6px 10px; font-weight:700; font-size:.88rem}
.p-chip.emph{border-color:#cfeede; background:#e9f9f0}
.prog-hero{margin:0 0 6px; border-radius:16px; overflow:hidden}
.prog-hero img{width:100%; display:block; border-radius:16px; object-fit:cover; box-shadow:0 12px 28px rgba(0,0,0,.08)}
.prog-card{border:0; border-radius:0; padding:0; background:transparent; box-shadow:none}
.prog-card h3{margin:.2rem 0 .6rem}
.prog-list{padding-left:18px; margin:.2rem 0}

/* Aha moment */
.aha{margin-top:8px;border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff8f2,#fff);box-shadow:0 6px 20px rgba(232,93,4,.08)}
.aha.hidden{display:none}
.aha strong{font-weight:800}
.aha small{color:#666}
.aha img{width:100%;display:block;border-radius:12px;margin-top:8px;box-shadow:0 8px 22px rgba(0,0,0,.08)}

/* Limited-time deal styles */
.deal{margin:8px 0 12px}
.deal-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.deal-badge{border:2px solid #ffd5c2;background:#fff7ef;border-radius:999px;padding:6px 10px;font-weight:800}
.deal-timer{margin-left:auto;font-weight:800;font-size:1.1rem;letter-spacing:.02em}
.offer-inline{border:2px solid var(--g);border-radius:16px;padding:12px;background:#fff;margin:10px 0}

/* Promo interstitials */
.promo{display:grid;gap:10px}
.promo-hero{margin:0;border-radius:16px;overflow:hidden;box-shadow:0 10px 22px rgba(0,0,0,.06)}
.promo-hero img,.promo-hero video{width:100%;display:block;border-radius:16px;object-fit:cover}
.promo h2{margin-top:2px}
 /* Скрыть кнопку "Посмотреть программу" только в инлайн-оффере экрана результата */
section[data-id="result"] #offerInline .actions { 
display: none !important; 
}
</style>
</head>
<body>
  <div class="app"><div class="card">
    <div id="progress"></div>
    <div id="screens"></div>
  </div></div>

  <!-- Лайтбокс -->
  <div id="lightbox" aria-hidden="true">
    <div class="x" id="lbClose" aria-label="Закрыть">×</div>
    <div style="text-align:center">
      <img id="lbImg" alt=""/>
      <div class="cap" id="lbCap"></div>
    </div>
  </div>

<script>
/* ====== Small helpers ====== */
const $=s=>document.querySelector(s),$$=(s,r=document)=>Array.from((r||document).querySelectorAll(s));
const vibrate=n=>{try{navigator.vibrate&&navigator.vibrate(n||12)}catch(e){}};
const A=JSON.parse(localStorage.getItem('sdq')||'{}'); const save=()=>localStorage.setItem('sdq',JSON.stringify(A));

/* dicts */
const AGE=['18–29','30–39','40–49','50+'];
const BODY=[{label:'Худощавое',key:'slim',img:'skinny.png',alt:'Худощавое телосложение'},{label:'Среднее',key:'avg',img:'slim.png',alt:'Среднее телосложение'},{label:'Крупное',key:'large',img:'medium.png',alt:'Крупное телосложение'},{label:'Избыточный вес',key:'obese',img:'xl.png',alt:'Избыточный вес'}];
const LIFE=['Сидячая работа','Умеренно активная','Активная'];
const EXP=['Никогда не занималась','Иногда дома / по видео','Регулярно'];
const MOT=['Для здоровья','Для внешности','Для энергии и лёгкости','Для уверенности в себе'];
const HEALTH=['Диабет','Проблемы со щитовидкой','Гипертония','Боль в суставах','Беременность','Нет'];

/* Сокращённые привычки */
const BAD=['Сладкие перекусы','Полуфабрикаты','Недосып','Частый стресс'];
const GOOD=['1.5–2 л воды','Овощи 400 г/день','Белок и фрукты в каждом приёме пищи','Сон 7-8 часов'];

/* кейсы */
const CASES = [
  { kg:14,   name:'Ольги',         months:4, img:'olga.png' },
  { kg:10,   name:'Александры',    months:4, img:'alexandra.png' },
  { kg:14,   name:'Екатерины',     months:6, img:'ekaterina.jpg' },
  { kg:8,    name:'Юлии',          months:4, img:'yulia.jpg' },
  { kg:17.5, name:'Светланы',      months:2, img:'svetlana.jpg' },
  { kg:7,    name:'Резеды',        months:2, img:'rezeda.jpg' },
  { kg:17.5, name:'Инны',          months:5, img:'inna.jpg' },
  { kg:16,   name:'Шагательницы',  months:3, img:'noname.jpg' }
];
function pickCase(targetKg){let best=null,diff=Infinity;for(const c of CASES){const d=Math.abs((c.kg||0)-targetKg);if(d<diff){diff=d;best=c}}return best}

/* scaffolding */
const screensRoot=$('#screens');
const section=(id,html)=>`<section class="screen${id==='intro'?' is':''}" data-id="${id}">${html}</section>`;
const chips=(id,arr)=>`<div class="chips" id="${id}">`+arr.map(t=>`<button type="button" class="chip" data-v="${t}">${t}</button>`).join('')+`</div>`;
const opts=(id,arr)=>`<div class="grid cols2" id="${id}">`+arr.map(t=>{let label,key;if(typeof t==='string'){label=t;key=t}else if(Array.isArray(t)){label=t[0];key=t[1]??t[0]}else if(t&&typeof t==='object'){label=t.label??t.value??t.key??'';key=t.key??t.value??t.label??''}else{label=String(t);key=String(t)}return `<label class="opt" data-v="${String(key)}"><span>${String(label)}</span></label>`}).join('')+`</div>`;
const actions=()=>`<div class="actions sticky"><button class="btn ghost" data-prev>Назад</button><button class="btn primary" data-next>Далее</button></div>`;

/* screens HTML */
const html=
section('intro',`
  <figure class="hero-wrap">
    <div class="hero-skel" id="heroSkel"></div>
    <video class="hero-media" autoplay muted playsinline loop preload="metadata" poster="logo.png">
      <source src="intro.mp4" type="video/mp4"/>
      <img src="logo.png" alt="ШАГАЙ ДОМА"/>
    </video>
  </figure>
  <h1>Узнайте, за сколько недель шагательные тренировки помогут вам похудеть</h1>
  <p class="hint">Ответьте на несколько вопросов — это займёт 1–2 минуты.</p>
  <div class="grid"><div><div class="hint">Как к вам обращаться?</div><input id="name" class="text" placeholder="Например: Ирина"></div></div>
  <div class="actions sticky"><button class="btn primary" data-next>Поехали →</button></div>
`)
+section('age',`<h2>Ваш возраст</h2>${opts('ageOpts',AGE)}${actions()}`)

/* PROMO 1: 1 млн подписчиков — 2.jpg */
+section('promo1',`
  <div class="promo">
    <figure class="promo-hero">
      <img src="2.jpg" alt="ШАГАЙ ДОМА⚡ — больше 1 млн подписчиков" loading="lazy" decoding="async">
    </figure>
    <h2>У ШАГАЙ ДОМА⚡ уже больше <b>1&nbsp;миллиона</b> подписчиков во всех соцсетях!</h2>
    <p class="hint"> Мы - одно из самых дружелюбных фитнес-сообществ</p>
    ${actions()}
  </div>
`)

+section('body',`
  <h2>Телосложение сейчас</h2>
  <div class="grid cols2" id="bodyOpts">
    ${BODY.map(o=>`<label class="opt opt--img" data-v="${o.key}"><img src="${o.img}" alt="${o.alt}"><span>${o.label}</span></label>`).join('')}
  </div>${actions()}
`)
+section('steps',`
  <h2>Сколько шагов вы проходите сейчас в день (примерно)?</h2>
  <input id="steps" type="range" min="0" max="25000" step="250" value="4000">
  <div class="hint">Сейчас: <b><span id="sv">4000</span> шагов</b></div>
  <p class="hint"><b>Подсказка:</b> найти шаги можно в приложении вашего телефона/браслета</p>
  ${actions()}
`)

/* PROMO 2: 10 000 в клубе — otzyv.jpg */
+section('promo2',`
  <div class="promo">
    <figure class="promo-hero">
      <img src="otzyv.jpg" alt="Уже больше 10 000 людей в клубе" loading="lazy" decoding="async">
    </figure>
    <h2>Уже больше <b>10&nbsp;000</b> людей в онлайн фитнес-клубе ШАГАЙ ДОМА ⚡</h2>
    <p class="hint">Каждый на своём уровне, но вместе мы — сильнее.</p>
    ${actions()}
  </div>
`)

+section('bmi',`
  <h2>Давайте посчитаем ваш ИМТ</h2>
  <p class="hint">Укажите ваш рост и вес — можно приблизительно.</p>
  <div class="grid cols2">
    <div><div class="hint">Рост, см</div><input id="h" type="number" class="text" placeholder="Например: 165"></div>
    <div><div class="hint">Вес, кг</div><input id="w" type="number" class="text" placeholder="Например: 72"></div>
  </div>
  <div id="bmiI" class="hint"></div>
  ${actions()}
`)
+section('life',`<h2>Образ жизни</h2>${opts('lifeOpts',LIFE)}${actions()}`)
+section('exp',`<h2>Опыт тренировок</h2>${opts('expOpts',EXP)}${actions()}`)

/* PROMO 3: 20 млн шагов — walkwalk.jpg */
+section('promo3',`
  <div class="promo">
    <figure class="promo-hero">
      <img src="walkwalk.jpg" alt="20 миллионов шагов каждый день" loading="lazy" decoding="async">
    </figure>
    <h2><b>20&nbsp;миллионов</b> шагов каждый день набирают участницы клуба 😍</h2>
    <p class="hint">Короткие шагательные тренировки — легко вписать в день.</p>
    ${actions()}
  </div>
`)

+section('goal',`
  <h2>Ваша цель</h2>
  <div class="goalw">
    <div class="goal-top">
      <div class="goal-card">
        <div class="goal-range">
          <div class="val"><span class="minus">−</span><span id="goalVal">5.0</span> кг</div>
          <div class="sub"><span id="goalBadge" class="goal-badge goal-mid">умеренно</span></div>
        </div>
        <input id="goalRange" type="range" min="0" max="20" step="0.5" value="5">
        <div class="hint">Потяните ползунок: 0 — поддерживать форму · 20 — амбициозная цель</div>
        <label class="goal-switch" style="margin-top:10px"><input id="goalKeep" type="checkbox"><span>Накачать мышцы</span></label>
      </div>
      <div class="goal-fig">
        <div class="goal-stack" id="goalStack">
          <img src="superfit.png" data-i="0" alt="superfit" loading="lazy" decoding="async">
          <img src="fit.png"      data-i="1" alt="fit"      loading="lazy" decoding="async">
          <img src="skinny.png"   data-i="2" alt="skinny"   loading="lazy" decoding="async">
          <img src="slim.png"     data-i="3" alt="slim"     loading="lazy" decoding="async">
          <img src="s.png"        data-i="4" alt="s"        loading="lazy" decoding="async">
          <img src="m.png"        data-i="5" alt="m"        loading="lazy" decoding="async">
          <img src="l.png"        data-i="6" alt="l"        loading="lazy" decoding="async">
          <img src="xl.png"       data-i="7" alt="xl"       loading="lazy" decoding="async">
          <img src="xxl.png"      data-i="8" alt="xxl"      loading="lazy" decoding="async">
          <div class="tape" id="goalTape"></div>
        </div>
      </div>
    </div>
    <p class="goal-note">Цель можно уточнить позже — расчёт адаптируется под ваш темп и самочувствие.</p>
    ${actions()}
  </div>
`)
+section('motivation',`<h2>Почему вы хотите заниматься спортом?</h2>${chips('motChips',MOT)}${actions()}`)
+section('perweek',`
  <h2>Сколько готовы тренироваться в неделю?</h2>
  ${chips('pwChips',['2 раза','3 раза','4–5 раз','Каждый день 20–30 мин'])}
  <div id="aha" class="aha hidden"></div>
  ${actions()}
`)

/* PROMO 4: 85% похудели — doposle.jpg */
+section('promo4',`
  <div class="promo">
    <figure class="promo-hero">
      <img src="doposle.jpg" alt="85% женщин в клубе похудели на 1–2 кг за первую неделю" loading="lazy" decoding="async">
    </figure>
    <h2><b>85%</b> женщин в клубе похудели на <b>1–2&nbsp;кг</b> за первую неделю тренировок 🔥</h2>
    <p class="hint">Стартовать легко, а результаты мотивируют продолжать.</p>
    ${actions()}
  </div>
`)

+section('hard',`
  <h2>Что сейчас даётся тяжелее всего?</h2>
  <div class="hardw">
    <div class="hard-cards" id="hardCards">
      <div class="hcard" data-k="walk"><div class="hhead"><div class="hicon">🚶‍♀️</div><div>Долгая прогулка утомляет</div></div></div>
      <div class="hcard" data-k="stairs"><div class="hhead"><div class="hicon">🪜</div><div>Каждый пролёт по лестнице — испытание</div></div></div>
      <div class="hcard" data-k="games"><div class="hhead"><div class="hicon">🎯</div><div>Стыдно включаться в активные игры</div></div></div>
      <div class="hcard" data-k="jumps"><div class="hhead"><div class="hicon">🦘</div><div>Прыжки</div></div></div>
      <div class="hcard" data-k="none"><div class="hhead"><div class="hicon">✅</div><div>Ничего из этого</div></div></div>
    </div>
    ${actions()}
  </div>
`)
+section('health',`<h2>Есть ли состояния, которые важно учитывать?</h2>${chips('healthChips',HEALTH)}<p class="hint">Если есть сомнения — проконсультируйтесь с врачом.</p>${actions()}`)
+section('nutrition',`<h2>Питание</h2>${opts('nutriOpts',[{label:'Буду питаться по меню-конструктору в клубе',key:'menu'},{label:'Хочу научиться правильно составлять тарелку',key:'plate'},{label:'Нет, пока без питания',key:'no'}])}${actions()}`)
+section('food',`
  <h2>Расскажите нам о ваших текущих привычках</h2>
  <div class="habit">
    <div class="habit-grid">
      <div class="col">
        <h3>Плохие привычки</h3>
        <div class="chips chips--pills" id="bad">
          ${BAD.map(x=>`<button type="button" class="chip" data-kind="bad" data-v="${x}">${x}</button>`).join('')}
        </div>
      </div>
      <div class="col">
        <h3>Хорошие привычки</h3>
        <div class="chips chips--pills" id="good">
          ${GOOD.map(x=>`<button type="button" class="chip" data-kind="good" data-v="${x}">${x}</button>`).join('')}
        </div>
      </div>
    </div>

    <div class="habit-meter hidden" id="hmWrap">
      <div class="hm-top"><div><span id="hmLabel">Индекс прогресса</span><span class="hm-badge hm-ok" id="hmBadge">нейтрально</span></div><span id="hmScore">0%</span></div>
      <div class="hm-track" id="hmTrack"><div class="hm-pointer" id="hmPtr"></div></div>
      <div class="hm-scale"><span>тормозит</span><span>нейтрально</span><span>ускоряет</span></div>
    </div>

    <p class="hint">Отметьте только то, что про вас — индикатор появится автоматически ✨</p>
    <div class="actions sticky"><button class="btn ghost" data-prev>Назад</button><button class="btn primary" id="calc">Рассчитать результат →</button></div>
  </div>
`)
+section('loading',`
  <div class="loader2"><div class="ring" id="lring"><div class="pct" id="lpct">0%</div></div>
  <div class="lmsg" id="lmsg">Собираем данные…</div><p class="hint" id="lsub">Возраст • ИМТ • Активность • Цель</p></div>
`)
+section('result',`
  <h2 id="rTitle">Готово!</h2>
  <div class="counter" id="nums">0 кг за 0 недель</div>
  <p class="hint" id="rSub"></p>
  <div id="caseBox" class="case hide"></div>

  <!-- Инлайн-предложение на экране результата: без кнопки покупки, с таймером 15 минут -->
  <div id="offerInline" class="offer-inline" style="display:none">
    <p class="hint" style="margin:0 0 8px 0">
      <b>Только для вас у нас действует специальное предложение: −70% на все абонементы в клуб!</b>
    </p>
    <div class="deal">
      <div class="deal-row" style="justify-content:flex-end">
        <span class="deal-timer" id="inlineTimer">15:00</span>
        <span class="deal-badge">Предложение ограничено</span>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="toPrograms">Посмотреть программу</button>
    </div>
  </div>

  <p class="hint" id="rDisc">Прогноз носит ознакомительный характер и не является медицинской рекомендацией.</p>
  <div class="actions sticky"><button class="btn ghost" data-prev>Назад</button><button class="btn primary" id="toCTA">Перейти к предложению!</button></div>
`)
+section('program',`
  <div class="prog-wrap">
    <div class="prog-head">
      <div class="p-title" id="progTitle">Мы рекомендуем вам…</div>
      <p class="p-sub" id="progLead"></p>
      <div class="p-chips" id="progChips"></div>
    </div>

    <figure class="prog-hero">
      <img src="program.png" alt="Рекомендуемая программа">
    </figure>

    <div class="prog-card">
      <h3>Почему это подойдёт именно вам</h3>
      <ul class="prog-list" id="progList"></ul>
    </div>

    <div class="actions sticky">
      <button class="btn ghost" data-prev>Назад</button>
      <button class="btn primary" id="toSale">К программе →</button>
    </div>
  </div>
`)
+section('sale',`
  <figure class="sale-hero"><img src="final.PNG" alt="Результаты участниц и атмосфера клуба «ШАГАЙ ДОМА»"></figure>
  <h2 id="sTitle">Присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡</h2>
  <p class="hint" id="sLead"></p>

  <p class="hint"><b>Только для вас у нас действует специальное предложение: −70% на все абонементы в клуб!</b></p>

  <!-- Таймер и бейдж ставим СРАЗУ ПОСЛЕ текста про спецпредложение -->
  <div class="deal">
    <div class="deal-row">
      <span class="deal-badge">Предложение ограничено</span>
      <span class="deal-timer" id="saleTimer">15:00</span>
    </div>
  </div>

  <ul>
    <li>Домашние шагательные тренировки 20–30 минут</li>
    <li>Готовые планы на неделю</li>
    <li>Поддержка и мотивация в чате</li>
    <li>Помощь куратора и сообщество единомышленниц</li>
  </ul>
  <div class="actions">
    <a class="btn primary" id="cta" href="https://walk-walk.ru/?utm_source=website&utm_medium=quiz&utm_campaign=looseweight" target="_blank" rel="noopener">Получить абонемент со скидкой 70%</a>
    <button class="btn ghost" data-prev>Назад</button>
  </div>
`);
screensRoot.innerHTML=html;
      document.getElementById('toPrograms')?.style.setProperty('display','none','important');
document.querySelector('#offerInline .actions')?.style.setProperty('display','none','important');

/* ===== Progress header ===== */
const progress=$('#progress');
progress.innerHTML=`<div class="pcirc"><div class="pct">0%</div></div><div class="plogo"><img src="logo.png" alt="ШАГАЙ ДОМА"></div>`;
const pcirc=()=>$('#progress .pcirc'),pcText=()=>$('#progress .pct');let pctNow=0,rafId=0;
function animProg(to){cancelAnimationFrame(rafId);const k=.08,d=.75;let v=0;function f(){const x=pctNow-to,a=-k*x;v=(v+a)*d;pctNow+=v;if(Math.abs(pctNow-to)<.3&&Math.abs(v)<.3)pctNow=to;pcirc().style.setProperty('--p',pctNow.toFixed(1)+'%');pcText().textContent=Math.round(pctNow)+'%';if(pctNow!==to)rafId=requestAnimationFrame(f)}rafId=requestAnimationFrame(f)}
let idx=0;const S=$$('#screens .screen');
function setP(i){progress.classList.toggle('hide',i===0);const p=Math.round(i/(S.length-1)*100);animProg(p)}
function show(n){S[idx].classList.remove('is');idx=Math.max(0,Math.min(S.length-1,n));S[idx].classList.add('is');setP(idx);scrollTo({top:0,behavior:'smooth'})}
setP(0);

/* navigation */
addEventListener('click',e=>{
  const next=e.target.closest('[data-next]');
  const prev=e.target.closest('[data-prev]');
  if(next){
    if(next.closest('section[data-id="intro"]')) return;
    vibrate(); goNext();
  }
  if(prev){vibrate(); show(idx-1)}
});
function shake(){S[idx].animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:260});vibrate(25)}
const need=k=>!A[k];
function goNext(){
  const id=S[idx].dataset.id;
  if(id==='age'&&need('age'))return shake();
  if(id==='body'&&need('body'))return shake();
  if(id==='bmi'&&(!A.h||!A.w))return shake();
  if(id==='life'&&need('life'))return shake();
  if(id==='exp'&&need('exp'))return shake();
  if(id==='goal'&&(A.goalKg==null))return shake();
  if(id==='perweek'&&need('perweek'))return shake();
  show(idx+1)
}
/* старт со вступления */
document.querySelector('section[data-id="intro"] [data-next]')?.addEventListener('click',(e)=>{
  e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
  vibrate(); show(1);
});

/* inputs */
$('#name').oninput=e=>{A.name=e.target.value.trim();save()};
const steps=$('#steps'),sv=$('#sv');function updRange(){const min=+steps.min||0,max=+steps.max||100,val=+steps.value||0,p=((val-min)/(max-min))*100;steps.style.setProperty('--pct',p+'%')}
if(steps){updRange();steps.oninput=e=>{A.steps=+e.target.value;sv.textContent=A.steps;updRange();save();updateAha()}}
/* BMI calc + label */
['h','w'].forEach(id=>{$('#'+id)?.addEventListener('input',()=>{updBMI();updateGoalPreview()})});
function bmiCat(b){if(b<18.5)return{label:'Дефицит массы',cls:'bmi-warn',note:'ниже нормы (18,5–24,9)'};if(b<25)return{label:'Норма',cls:'bmi-ok',note:'в пределах нормы'};if(b<30)return{label:'Избыточная масса',cls:'bmi-warn',note:'выше нормы'};if(b<35)return{label:'Ожирение I ст.',cls:'bmi-bad',note:'выше нормы'};if(b<40)return{label:'Ожирение II ст.',cls:'bmi-bad',note:'значительно выше нормы'};return{label:'Ожирение III ст.',cls:'bmi-bad',note:'значительно выше нормы'}}
function updBMI(){const h=+$('#h').value,w=+$('#w').value;if(h>0&&w>0){A.h=h;A.w=w;const m=h/100;A.bmi=+(w/(m*m)).toFixed(1);save();const c=bmiCat(A.bmi);$('#bmiI').innerHTML=`Ваш ИМТ: <b>${A.bmi}</b> <span class="bmi-tag ${c.cls}">${c.label}</span><br><span class="hint bmi-line">ИМТ помогает ориентироваться в массе тела; норма — 18,5–24,9. Учитывайте особенности телосложения, беременность и мышечную массу.</span>`}else{$('#bmiI').textContent=''}}

/* селекторы */
function selectList(root,key,single){if(!root)return;root.addEventListener('click',e=>{const sel=e.target.closest(single?'.opt':'.chip');if(!sel)return;if(single){$$('.opt',root).forEach(x=>x.classList.remove('is'));sel.classList.add('is');A[key]=sel.dataset.v||sel.textContent}else{sel.classList.toggle('is');A[key]=$$('.chip.is',root).map(x=>x.dataset.v||x.textContent)}save();vibrate(8); if(root.id==='bad'||root.id==='good') setTimeout(updMeter,0); if(root.id==='pwChips') updateAha();})}
selectList($('#ageOpts'),'age',true);
selectList($('#bodyOpts'),'body',true);
selectList($('#lifeOpts'),'life',true);
selectList($('#expOpts'),'exp',true);
selectList($('#motChips'),'mot',false);
selectList($('#pwChips'),'perweek',false);
selectList($('#healthChips'),'health',false);
selectList($('#bad'),'bad',false);
selectList($('#good'),'good',false);
selectList($('#nutriOpts'),'nutri',true);

/* индикатор привычек */
function nutrPreview(){const b=(A.bad||[]).length,g=(A.good||[]).length;let f=1;f+=g*.02;f-=b*.03;return Math.max(.7,Math.min(1.35,f))}
function updMeter(){
  const b=(A.bad||[]).length,g=(A.good||[]).length, any=b+g>0;
  $('#hmWrap').classList.toggle('hidden',!any);
  if(!any) return;
  const f=nutrPreview(),acc=Math.round((f-1)*100);
  const ptr=$('#hmPtr'),track=$('#hmTrack'),score=$('#hmScore'),badge=$('#hmBadge');
  const min=-30,max=35,clamp=Math.max(min,Math.min(max,acc)),p=((clamp-min)/(max-min))*100;
  track.style.setProperty('--p',p+'%');ptr.style.left=p+'%';
  score.textContent=(acc>0?'+':'')+acc+'%';
  let cls='hm-ok',txt='нейтрально',border='#FFBA08';
  if(acc<=-15){cls='hm-bad';txt='сильно тормозит';border='#E85D04'}
  else if(acc<-5){cls='hm-bad';txt='тормозит';border='#E85D04'}
  else if(acc>15){cls='hm-good';txt='суперускорение';border:'#12A06A'}
  else if(acc>5){cls='hm-good';txt='ускоряет';border:'#12A06A'}
  badge.className='hm-badge '+cls;badge.textContent=txt;ptr.style.borderColor=border;
}
updMeter();

/* hard cards */
(function setupHard(){const w=$('#hardCards');if(!w)return;const cs=$$('.hcard',w);if(A.hardKey){cs.find(c=>c.dataset.k===A.hardKey)?.classList.add('is')}w.addEventListener('click',e=>{const c=e.target.closest('.hcard');if(!c)return;cs.forEach(x=>x.classList.toggle('is',x===c));A.hardKey=c.dataset.k;A.hard={'walk':'Долгая прогулка утомляет','stairs':'Каждый пролёт по лестнице — испытание','games':'Стыдно включаться в активные игры','jumps':'Прыжки','none':'Ничего из этого'}[A.hardKey];save();vibrate(8)})})();

/* ===== Goal preview (image crossfade) ===== */
const BMI_ANCHORS=[18.8,20.0,21.8,23.5,26.0,29.0,32.0,35.0,38.0];
function indexFromBMI(bmi){
  const B=BMI_ANCHORS, N=B.length-1;
  if(bmi<=B[0]) return 0;
  if(bmi>=B[N]) return N;
  for(let i=0;i<N;i++){ if(bmi>=B[i] && bmi<=B[i+1]){ const t=(bmi-B[i])/(B[i+1]-B[i]); return i+t; } }
  return N;
}
function bodyToIndex(bodyKey,N){const frac={slim:3/8,avg:5/8,large:7/8,obese:1.0}[bodyKey] ?? 5/8;return frac*(N-1)}
function crossfade(imgs,t){
  const N=imgs.length-1,tt=Math.max(0,Math.min(N,t));
  const iLo=Math.floor(tt), iHi=Math.ceil(tt), f=tt-iLo;
  imgs.forEach(img=>{img.style.opacity=0;img.style.transform='scale(1)'});
  if(iLo===iHi){ if(imgs[iLo]) imgs[iLo].style.opacity=1; }
  else{
    const lo=imgs[iLo],hi=imgs[iHi];
    if(lo){ lo.style.opacity=1-f; lo.style.transform=`scale(${1-0.02*f})`; }
    if(hi){ hi.style.opacity=f;   hi.style.transform=`scale(${1-0.03*(1-f)})`; }
  }
}
function updateGoalPreview(){
  const stack=$('#goalStack'); if(!stack) return;
  const imgs=Array.from(stack.querySelectorAll('img[data-i]')).sort((a,b)=>(+a.dataset.i)-(+b.dataset.i));
  const N=imgs.length; if(N<1) return;

  const keepOn=$('#goalKeep')?.checked || !!A.keep;
  if(keepOn){
    imgs.forEach(img=>{img.style.opacity=0;img.style.transform='scale(1)'});
    const fit = imgs.find(img => /(^|\/)fit\.png$/i.test(img.getAttribute('src')||'')) || imgs[1];
    if(fit) fit.style.opacity=1; return;
  }

  const kg=+A.goalKg||0;
  const h=+A.h>0?A.h/100:null, w=+A.w>0?+A.w:null;

  if(h && w){
    const w2=Math.max(0.1, w - kg);
    const bmi2=w2/(h*h);
    const t=indexFromBMI(bmi2);
    crossfade(imgs,t);
  }else{
    const start=bodyToIndex(A.body||'avg',N);
    const t=Math.max(0,start - (kg/4));
    crossfade(imgs,t);
  }
}
function gBucket(kg){const v=+kg;if(v<=0)return'Накачать мышцы';if(v<=5)return'Сбросить 3–5 кг';if(v<=10)return'Сбросить 5–10 кг';return'Сбросить 10+ кг'}
function updGoal(){const kg=+A.goalKg||0;$('#goalVal').textContent=kg.toFixed(1);const b=$('#goalBadge');let cls='goal-mid',txt='умеренно';if(kg===0){cls='goal-soft';txt='поддержание'}else if(kg<=5){cls='goal-soft';txt='мягко'}else if(kg<=10){cls='goal-mid';txt='умеренно'}else{cls='goal-hard';txt='интенсивно'}b.className='goal-badge '+cls;b.textContent=txt;const rng=$('#goalRange'),pct=kg/(+rng.max)*100;rng.style.setProperty('--pct',pct+'%');updateGoalPreview()}
function setGoal(val){const kg=Math.max(0,Math.min(20,+val||0));A.goalKg=kg;A.goal=gBucket(kg);save();updGoal()}
function toggleKeep(ch){const rng=$('#goalRange');A.keep=!!ch;save();if(ch){rng.disabled=true;setGoal(0)}else{rng.disabled=false;if((+A.goalKg||0)===0)setGoal(5)}updateGoalPreview()}
const goalR=$('#goalRange'),goalK=$('#goalKeep');
goalR.oninput=e=>setGoal(e.target.value);goalK.onchange=e=>toggleKeep(e.target.checked);
(()=>{const kg=(A.goalKg!=null)?+A.goalKg:5;goalR.value=kg;const keep=(A.keep===true)||kg===0;goalK.checked=keep;toggleKeep(keep);if(!keep)setGoal(kg);updateGoalPreview()})();

/* Aha moment */
function freqFromPerweek(){
  const sel=A.perweek||[]; let s=0;
  for(const v of sel){
    if(/Каждый день/.test(v)) s=Math.max(s,7);
    else if(/4–5/.test(v)) s=Math.max(s,5);
    else if(/3/.test(v)) s=Math.max(s,3);
    else if(/2/.test(v)) s=Math.max(s,2);
  } return s;
}
function updateAha(){
  const box=$('#aha'); if(!box) return;
  const s=freqFromPerweek();
  if(!s){ box.classList.add('hidden'); return; }
  const minPerSess=25;
  const eqSteps=3000;
  const base=(+A.steps||4000)*7;
  const addSteps=s*eqSteps;
  let factor=base>0 ? (base+addSteps)/base : 0;
  factor=Math.min(2.5,Math.max(1.1,factor));
  const factorTxt=factor.toLocaleString('ru-RU',{maximumFractionDigits:1});
  const addTxt=addSteps.toLocaleString('ru-RU');
  const freqLabel = s===7 ? 'каждый день' : `~${s} раз(а)`;
  box.innerHTML = `
    <div><strong>Супер!</strong> Если вы будете тренироваться <b>${freqLabel}</b> по <b>${minPerSess} минут</b>,
    ваша недельная активность вырастет <b>примерно в ${factorTxt} раза</b> (ещё ~<b>${addTxt}</b> шагов в неделю).<br>
    <small>Чем выше активность — тем быстрее идёт снижение веса.</small></div>
    <img src="chart.jpg" alt="Как тренировки увеличивают активность">
  `;
  box.classList.remove('hidden');
}
updateAha();

/* Загрузка + результат */
function runLoading(done){
  const ring=$('#lring'),lpct=$('#lpct'),lmsg=$('#lmsg'),lsub=$('#lsub');
  const stepsTxt=['Учитываем ваш возраст','Смотрим телосложение и ИМТ','Проверяем активность и опыт','Добавляем шаги и питание','Готовим персональный прогноз…'];
  let si=0;lmsg.textContent=stepsTxt[0];lsub.textContent='Возраст • ИМТ • Активность • Цель';
  const D=1500,t0=performance.now();
  function tick(n){
    const p=Math.min(1,(n-t0)/D),ease=1-Math.pow(1-p,3),pct=Math.round(5+95*ease);
    ring.style.setProperty('--p',pct+'%');lpct.textContent=pct+'%';
    const i=Math.min(stepsTxt.length-1,Math.floor(p*stepsTxt.length));
    if(i!==si){si=i;lmsg.textContent=stepsTxt[si]}
    if(p<1)requestAnimationFrame(tick);else setTimeout(()=>{ try{ done(); } catch(err){ console.error(err); fallbackResult(); } },200)
  }
  requestAnimationFrame(tick)
}
const idxBy=id=>$$('#screens .screen').findIndex(s=>s.dataset.id===id);
$('#calc').onclick=()=>{ show(idx+1); runLoading(()=>{ try{ calculate(); } catch(e){ console.error(e); fallbackResult(); } }); };
function fallbackResult(){const name=A.name?.trim()||'Друзья';$('#rTitle').textContent=`${name}, ваш прогноз готов ✨`;$('#nums').textContent=`≈ −${goalKg()} кг за 8 недель`;$('#rSub').textContent='Мы подготовили ориентировочный план по вашим данным.';show(idxBy('result'));}

/* Темп */
function fAge(){const a=A.age||'';if(/50/.test(a))return 0.88;if(/40/.test(a))return 0.94;if(/30/.test(a))return 0.98;return 1.06}
function fLife(){const l=A.life||'';if(/Сидячая/.test(l))return 0.90;if(/Умеренно/.test(l))return 1.00;return 1.08}
function fExp(){const e=A.exp||'';if(/Никогда/.test(e))return 0.95;if(/Регулярно/.test(e))return 1.08;return 1.00}
function fBody(){switch(A.body){case 'slim':return .92;case 'avg':return 1.00;case 'large':return .96;case 'obese':return .92;default:return 1.00}}
function fSteps(){const now=+A.steps||4000,add=2000,t=now+add;let boost=1+add/10000;if(now<3000)boost+=.08;if(now>9000)boost-=.06;return{f:Math.max(.95,Math.min(1.28,boost)),t}}
function fNutri(){let f=1;if(A.nutri==='menu')f+=.22;else if(A.nutri==='plate')f+=.12;else f-=.12;f-=((A.bad||[]).length)*.03;f+=Math.min(((A.good||[]).length)*.02,.10);return Math.max(.7,Math.min(1.35,f))}
function fHealth(){const h=new Set(A.health||[]);let f=1;if(h.has('Диабет')||h.has('Проблемы со щитовидкой')||h.has('Гипертония'))f-=.06;if(h.has('Боль в суставах'))f-=.04;return Math.max(.8,f)}
function fPain(){switch(A.hardKey){case 'walk':return .94;case 'stairs':return .93;case 'games':return .96;case 'jumps':return .95;case 'none':return 1.02;default:return 1.00}}

/* Скорость (кг/нед) */
function rate(){
  const w=+A.w||0;
  if(w>=100) return 1.0;
  let r=.5;
  const bmi=A.bmi||26;
  if(bmi>=30) r+=.08; else if(bmi<23) r-=.08;
  r*=fAge()*fLife()*fExp()*fBody()*fSteps().f*fNutri()*fHealth()*fPain();
  return Math.max(.25,Math.min(.9,+r.toFixed(2)));
}

/* Формат срока */
function fmtDuration(wks){
  if (wks <= 10) { return { start: 12, value: wks, unitText: 'недель', label: `${wks} недель` }; }
  const months = Math.ceil(wks / 4); return { start: 6, value: months, unitText: 'мес.', label: `${months} мес.` };
}
function goalKg(){
  if(A.goalKg!=null) return Math.max(0,Math.min(20,+A.goalKg));
  const g=A.goal||''; if(g.includes('3–5'))return 4; if(g.includes('5–10'))return 8; if(g.includes('10+'))return 12; return 3;
}

/* Вывод результата */
function calculate(){
  const name=A.name?.trim()||'Друзья',kg=goalKg(),rt=rate();
  const wks=Math.max(4,Math.min(16,Math.ceil(kg/rt))),t=fSteps().t;
  const dur=fmtDuration(wks);

  $('#rTitle').textContent=`${name}, ваш прогноз готов ✨`;
  animNum(dur.start,dur.value,1400,v=>{
    $('#nums').textContent=`−${kg} кг за ${v} ${dur.unitText}`;
  });
  const rtText=rt.toLocaleString('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1});
  $('#rSub').innerHTML=
    `С тренировками ШАГАЙ ДОМА ⚡️ вы будете проходить <b>${t.toLocaleString('ru-RU')}</b> шагов каждый день!<br>
     <span class="hint">Ориентировочный темп снижения веса: <b>~${rtText} кг/неделю</b>.</span>`;

  const caseObj = pickCase(Math.round(kg));
  renderCaseBox(caseObj);

  /* Текст на финальном экране: без "−0 кг", если цель 0 */
  const durLabel = dur.label;
  const leadSale = kg>0
    ? `Чтобы прийти к цели <b>−${kg} кг</b> за <b>${durLabel}</b> — подключите готовые планы и поддержку. Первые изменения уже через 1–2 недели.`
    : `Чтобы прийти к цели за <b>${durLabel}</b> — подключите готовые планы и поддержку. Первые изменения уже через 1–2 недели.`;
  $('#sTitle').textContent=`${name}, присоединяйтесь к клубу «ШАГАЙ ДОМА» ⚡`;
  $('#sLead').innerHTML=leadSale;

  /* Показать инлайн-предложение (без покупки) */
  $('#offerInline').style.display='block';

  show(idxBy('result'))
}
function animNum(a,b,d,cb){const s=performance.now(),ease=t=>1-Math.pow(1-t,3);function fr(n){const p=Math.min(1,(n-s)/d);cb(Math.round(a+(b-a)*ease(p)));if(p<1)requestAnimationFrame(fr)}requestAnimationFrame(fr)}

/* Кейс + лайтбокс */
function renderCaseBox(c){
  const box=document.getElementById('caseBox'); if(!box) return;
  if(!c){ box.classList.add('hide'); return; }
  const caption=`Как у нашей шагательницы ${c.name}! Она уже сбросила ${c.kg} кг за ${c.months} мес. в клубе.`;
  const img = c.img ? `<img src="${c.img}" alt="${c.name}" id="caseImg">` : `<img src="logo.png" alt="ШАГАЙ ДОМА" id="caseImg">`;
  box.innerHTML = `${img}
    <div>
      <h3>Как у нашей шагательницы ${c.name}!</h3>
      <p>Она уже сбросила <b>${c.kg}</b> кг за <b>${c.months}</b> мес. в клубе.</p>
    </div>`;
  box.classList.remove('hide');
  const preview=box.querySelector('#caseImg');
  preview?.addEventListener('click', ()=> openLightbox(preview.src, caption));
}
const lightbox = $('#lightbox'), lbImg=$('#lbImg'), lbCap=$('#lbCap'), lbClose=$('#lbClose');
function openLightbox(src, caption){ if(!src) return; lbImg.src=src; lbCap.textContent=caption||''; lightbox.classList.add('show'); lightbox.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeLightbox(){ lightbox.classList.remove('show'); lightbox.setAttribute('aria-hidden','true'); lbImg.src=''; lbCap.textContent=''; document.body.style.overflow=''; }
lightbox.addEventListener('click', e => { if(e.target===lightbox) closeLightbox(); });
lbClose.addEventListener('click', closeLightbox);

/* Программы */
function chooseProgram(){
  const w=+A.w||0, age=A.age||'', life=A.life||'', exp=A.exp||'', steps=+A.steps||0, bmi=+A.bmi||0;

  if (w>=100) return {
    key:'p100', title:'Тренировки для 100+',
    lead:'Бережные шагательные тренировки с акцентом на безопасность и суставы.',
    meta:{workouts:'7 тренировок', duration:'15–20 минут', tempo:'Темп низкий', steps:'2–2,5 тыс шагов'}
  };

  if (/50\+/.test(age)) return {
    key:'p50', title:'Тренировки для 50+',
    lead:'Мягкая координация, баланс и гибкость — без перегрузки.',
    meta:{workouts:'7 тренировок', duration:'15–20 минут', tempo:'Темп средний'}
  };

  const isActive = /Активная/.test(life) || steps>=8000 || /Регулярно/.test(exp) || (bmi && bmi<25);
  if (isActive) return {
    key:'active', title:'Шагай дома. Активно',
    lead:'Больше шагов и кардио-нагрузки для более быстрого результата.',
    meta:{workouts:'7 тренировок', duration:'15–40 минут', tempo:'Темп высокий', steps:'2–6 тыс шагов'}
  };

  return {
    key:'base', title:'Шагай дома. База',
    lead:'Комфортный старт, чтобы втянуться без стресса.',
    meta:{workouts:'8 тренировок', duration:'15–20 минут', tempo:'Темп низкий'}
  };
      }

      /* Персонализируем пункты «почему это вам подойдёт» */
function buildProgramBullets(p){
  const B=[];
  const name=A.name?.trim();
  if(name) B.push(`${name}, начнём с темпа, который будет комфортен именно вам.`);
  if(/50\+/.test(A.age||'')) B.push('Движения подобраны бережно: баланс, гибкость, координация.');
  const bmi=A.bmi||0; if(bmi){ if(bmi>=30) B.push('Щадим колени и спину, работаем на результат.'); else if(bmi<23) B.push('Больше тонуса и выносливости — поддержим форму.');}
  if(A.body==='obese'||A.body==='large') B.push('Постепенно повышаем нагрузку, чтобы прогресс был устойчивым.');
  if(/Сидячая/.test(A.life||'')) B.push('Короткие сессии 15–20 минут — легко вписать даже если вы много работаете.');
  const st=+A.steps||0; if(st && st<5000) B.push(`План увеличит ваш шагомер с ~${st.toLocaleString('ru-RU')} до +2 000 шагов/день без перегруза.`);
  if(/Никогда/.test(A.exp||'')) B.push('Покажем технику в простых шагах: без сложных связок и терминов.');
  if(/Регулярно/.test(A.exp||'')) B.push('Добавим интервалы и прогрессию нагрузки для роста формы.');
  const h=new Set(A.health||[]);
  if(h.has('Боль в суставах')) B.push('Упор на мягкую амплитуду, суставную мобилизацию и безударные шаги.');
  if(h.has('Диабет')||h.has('Гипертония')||h.has('Проблемы со щитовидкой')) B.push('Равномерный темп: следим за самочувствием и пульсом.');
  switch(A.hardKey){
    case 'walk': B.push('Укрепим выносливость постепенным увеличением длительности.'); break;
    case 'stairs': B.push('Добавим силовые шаги для ног, чтобы лестница перестала быть испытанием.'); break;
    case 'jumps': B.push('Только безударные варианты — никакого дискомфорта от прыжков.'); break;
  }
  const mot=(A.mot||[]); if(mot.includes('Для внешности')) B.push('Работаем с объёмами талии и бёдер — заметные изменения к 4–6 неделе.');
  if(mot.includes('Для энергии и лёгкости')) B.push('Больше энергии и лёгкости уже через 1–2 недели.');
  if(mot.includes('Для здоровья')) B.push('Бережная аэробная нагрузка — поддержка сердца, сосудов и дыхания.');
  if(mot.includes('Для уверенности в себе')) B.push('Понятный план и поддержка сообщества — мотивация не пропадёт.');
  const kg=(A.goalKg!=null)?+A.goalKg:0;
  if(kg>0) B.push(`Двигаемся к вашей цели −${kg} кг безопасным темпом, без рывков.`);
  else B.push('Поддержим форму, усилим тонус и выносливость — без изнурения.');
  return B.slice(0,7);
}

function renderProgram(){
  const p=chooseProgram();
  const title = `У нас 28 программ, но вам лучше начать с «${p.title}». Входит в любой абонемент!`;
  const leadParts=[p.lead];
  if(/Активная/.test(A.life||'')||/Регулярно/.test(A.exp||'')) leadParts.push('Подойдёт, если вы любите более высокий темп.');
  if(/Сидячая/.test(A.life||'')) leadParts.push('Подойдёт, если вы много сидите и хотите мягко вернуться к активности.');

  const chips=[];
  if (p.meta?.workouts) chips.push(p.meta.workouts);
  if (p.meta?.duration) chips.push(p.meta.duration);
  if (p.meta?.steps)    chips.push(p.meta.steps);
  if (p.meta?.tempo)    chips.push(p.meta.tempo);

  const chipsHtml = chips.map(t=>`<span class="p-chip${/высокий/i.test(t)?' emph':''}">${t}</span>`).join('');

  const progTitleEl = document.getElementById('progTitle');
  const progLeadEl  = document.getElementById('progLead');
  const progChipsEl = document.getElementById('progChips');
  const ul = document.getElementById('progList');

  if (progTitleEl) progTitleEl.textContent = title;
  if (progLeadEl)  progLeadEl.textContent  = leadParts.join(' ');
  if (progChipsEl) progChipsEl.innerHTML   = chipsHtml;

  if (ul){
    ul.innerHTML='';
    buildProgramBullets(p).forEach(b=>{const li=document.createElement('li');li.textContent=b;ul.appendChild(li)});
  }
}

/* ===== Таймеры и офферы ===== */

/* 15-минутный дедлайн (перезапускается, если истёк) */
function getDeadline(){
  let t=+localStorage.getItem('sdq_offer_deadline_15')||0;
  const now=Date.now();
  if(!t || t<now){ t = now + 15*60*1000; localStorage.setItem('sdq_offer_deadline_15', String(t)); }
  return t;
}
function fmtHMS(ms){
  let sec=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(sec/3600); sec-=h*3600;
  const m=Math.floor(sec/60); const s=sec%60;
  const pad=n=>String(n).padStart(2,'0');
  return h>0 ? `${pad(h)}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
}
let __sdqTimerInt = null;
function startTimers(){
  if(__sdqTimerInt) { clearInterval(__sdqTimerInt); __sdqTimerInt=null; }
  const deadline=getDeadline();
  const saleTimer  = document.getElementById('saleTimer');
  const inlineTimer= document.getElementById('inlineTimer');

  const tick=()=>{
    const rem=deadline - Date.now();
    const str=fmtHMS(rem);
    if(saleTimer)   saleTimer.textContent   = str;
    if(inlineTimer) inlineTimer.textContent = str;
    if(rem<=0){
      clearInterval(__sdqTimerInt);
      __sdqTimerInt=null;
    }
  };
  tick();
  __sdqTimerInt=setInterval(tick,1000);
}

/* Перестановка на sale (на всякий случай) */
function layoutSaleOffer(){
  const saleSection = document.querySelector('section[data-id="sale"]');
  if(!saleSection) return;
  const deal = saleSection.querySelector('.deal');
  const specialP = Array.from(saleSection.querySelectorAll('p.hint'))
    .find(p=>/Только для вас у нас действует специальное предложение/i.test(p.textContent||''));
  if (deal && specialP && !(deal.compareDocumentPosition(specialP) & Node.DOCUMENT_POSITION_FOLLOWING)){
    specialP.insertAdjacentElement('afterend', deal);
  }
}

/* Переходы */
const btnToCTA   = document.getElementById('toCTA');
const btnToSale  = document.getElementById('toSale');

if (btnToCTA)  btnToCTA.onclick  = ()=>{ renderProgram(); const i=idxBy('program'); if(i>=0) show(i); };
if (btnToSale) btnToSale.onclick = ()=>{ const i=idxBy('sale'); if(i>=0) show(i); };

document.addEventListener('click',(e)=>{
  const b=e.target.closest('#toPrograms');
  if(b){
    renderProgram();
    const i=idxBy('program');
    if(i>=0) show(i);
  }
});

/* hero skeleton hide */
const hv=document.querySelector('video.hero-media'),hs=document.getElementById('heroSkel');
function hideS(){hs&&hs.classList.add('hide')}
hv?.addEventListener('loadeddata',hideS,{once:true});
hv?.addEventListener('canplay',hideS,{once:true});
hv?.addEventListener('error',()=>setTimeout(hideS,1000),{once:true});
setTimeout(hideS,2000);

/* init */
(function initOfferTweaks(){
  try{
    layoutSaleOffer();   // на финальном — «Предложение ограничено» сразу после текста
    startTimers();       // запустить оба таймера (15 минут)
  }catch(e){ console.error(e); }
})();

/* Перезапуск таймера после расчёта результата */
const __oldCalculate = (typeof calculate === 'function') ? calculate : null;
if (__oldCalculate){
  window.calculate = function(){
    __oldCalculate.apply(this, arguments);
    // После показа результата обновляем таймер
    startTimers();
  };
}
</script>
</body>
</html>

