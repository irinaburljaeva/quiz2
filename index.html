<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Калькулятор от ШАГАЙ ДОМА⚡</title>
<meta name="description" content="Узнайте, за сколько недель шагательные тренировки помогут вам похудеть."/>
<meta name="color-scheme" content="light only"/>
<link rel="preload" as="image" href="superfit.png">
<link rel="preload" as="image" href="m.png">
<link rel="preload" as="image" href="xxl.png">
<style>
:root{
  --bg:#fff; --txt:#0c0c0c; --sub:#606060; --mut:#999; --g:#e9e9e9; --gg:#f3f3f3;
  --brand:#CF2C02; --brand2:#E85D04; --brand3:#FFBA08; --ok:#089c39; --bad:#d31919;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
img{max-width:100%}
button{border:0;cursor:pointer}
.hidden{display:none !important}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--g);font-weight:700;font-size:.9rem;white-space:nowrap}
.badge b{font-size:1rem}
.btn{display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 16px;border-radius:10px;font-weight:800}
.btn.primary{background:var(--brand);color:#fff}
.btn.ghost{background:#fff;border:2px solid var(--g)}
.btn.wide{width:100%}
.actions{display:flex;gap:10px;align-items:center;justify-content:space-between}
.actions.sticky{position:sticky;bottom:0;z-index:5;background:linear-gradient(0deg,#fff,rgba(255,255,255,.95));padding-top:8px}
.header{position:sticky;top:0;z-index:6;background:#fff;border-bottom:1px solid var(--g)}
.header .inner{display:flex;align-items:center;gap:10px;padding:10px 12px}
.logo{display:flex;align-items:center;gap:8px;font-weight:900;letter-spacing:.02em}
.logo .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
.container{max-width:780px;margin:0 auto;padding:10px 12px 24px}
h1{margin:10px 0 12px;font-size:clamp(22px,7vw,32px);line-height:1.1;letter-spacing:-.02em}
.sub{color:var(--sub);margin:0 0 6px}
.hero{display:grid;gap:10px}
.hero .card{border:1px solid var(--g);border-radius:12px;padding:10px;background:#fff}
.inline-opts{display:flex;flex-wrap:wrap;gap:10px}
.inline-opts .opt{border:2px solid var(--g);border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
.inline-opts .opt.is{background:#fff7ef;border-color:#ffd5c2}
grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
grid-2 .card{border:1px solid var(--g);border-radius:12px;padding:10px;background:#fff}
small.mut{color:#777}
.slide{display:grid;gap:12px}
.progress{height:10px;background:#f2f2f2;border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));width:0}
.answer-opts{display:grid;gap:10px}
.answer-opts .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:2px solid var(--g);border-radius:999px;background:#fff;font-weight:800;cursor:pointer;user-select:none}
.answer-opts .chip.is{background:#fff7ef;border-color:#ffd5c2}
.answer-opts .chip .dot{width:10px;height:10px;border-radius:50%;background:var(--g)}
.answer-opts .chip.is .dot{background:var(--brand)}
.answer-opts .chip img{width:32px;height:32px;border-radius:8px;object-fit:cover}
.answer-opts .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.answer-opts .grid .chip{width:100%;justify-content:flex-start}
.media{border:1px solid var(--g);border-radius:12px;overflow:hidden}
.media .ph{display:grid;place-items:center;aspect-ratio:16/9;background:#000;color:#fff;font-weight:800}
.hero-img{border-radius:12px;overflow:hidden}
.hero-img img{display:block;width:100%;height:auto}
.kg{display:flex;align-items:center;gap:8px}
.kg input{width:100%;height:44px;border:1px solid var(--g);border-radius:8px;padding:0 10px;font-weight:800;font-size:1rem}
.kg .badge{height:38px}
.hint{font-size:.95rem;color:#333}
hr.sep{margin:14px 0;border:0;border-top:1px dashed var(--g)}
/* Trial video */
.video-tabs{display:flex;gap:8px;flex-wrap:wrap}
.video-tabs .tab{border:2px solid var(--g);border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer;background:#fff}
.video-tabs .tab.is{background:#fff0e5;border-color:#ffc9ad}
.video-embed{position:relative;border:1px solid var(--g);border-radius:12px;overflow:hidden}
.video-embed iframe{display:block;width:100%;height:54vw;max-height:420px}
@media (min-width:740px){ .video-embed iframe{height:440px} }

/* === Program slide === */
.prog-wrap{display:grid;gap:12px}
.prog-head{position:relative;border:2px solid var(--g);border-radius:16px;padding:14px 12px;background:
  radial-gradient(120% 80% at 0% 0%, rgba(255,240,230,.9), transparent 50%),
  radial-gradient(120% 80% at 100% 100%, rgba(255,247,236,.9), transparent 55%),
  linear-gradient(180deg,#fff,#fff);overflow:hidden}
.prog-head::after{content:"";position:absolute;right:-40px;top:-40px;width:160px;height:160px;border-radius:50%;
  background:conic-gradient(from 0deg, #FFBA08, #E85D04);opacity:.15;filter:blur(6px)}
.p-title{margin:.2rem 0 6px;font-size:clamp(20px,5vw,28px);font-weight:800;letter-spacing:-.02em}
.p-sub{margin:0;color:#555}
.p-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.p-chip{border:2px solid #ffd5c2;background:#fff7ef;border-radius:999px;padding:6px 10px;font-weight:700;font-size:.88rem}
.p-chip.emph{border-color:#cfeede;background:#e9f9f0}
.prog-hero{margin:0 0 6px;border-radius:16px;overflow:hidden;box-shadow:0 10px 22px rgba(0,0,0,.06)}
.prog-hero img{width:100%;display:block;border-radius:16px;object-fit:cover}
.prog-card{border:0;border-radius:0;padding:0;background:transparent;box-shadow:none}
.prog-card h3{margin:.2rem 0 .6rem}
.prog-list{padding-left:18px;margin:.2rem 0}
</style>
</head>
<body>
<header class="header">
  <div class="inner">
    <div class="logo"><span class="dot"></span> ШАГАЙ ДОМА</div>
  </div>
</header>

<div class="container">
  <h1>Калькулятор: за сколько недель вы похудеете на шагательных тренировках</h1>
  <p class="sub">Ответьте на несколько вопросов — мы посчитаем безопасный срок и покажем, с какой программы начать.</p>

  <div class="progress"><i id="progbar" style="width:0%"></i></div>

  <div id="screens"></div>

  <div class="actions sticky">
    <button class="btn ghost" data-prev>Назад</button>
    <button class="btn primary wide" id="next">Далее</button>
  </div>
</div>

<script>
/* ====== Utils ====== */
const $=sel=>document.querySelector(sel);
const $$=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
function vibrate(ms=10){ if(navigator.vibrate) try{navigator.vibrate(ms)}catch{} }
function save(){ try{ localStorage.setItem('walk_calc', JSON.stringify(A)) }catch{} }
function load(){ try{ return JSON.parse(localStorage.getItem('walk_calc')||'{}') }catch{ return {} } }

/* State */
const A = Object.assign({
  perweek:null, steps:null, age:null, body:null, life:null, exp:null, mot:[],
  good:[], bad:[], nutri:null, keep:false
}, load());

/* Trial video embeds (updated) */
const TRIAL_EMBEDS = {
  vk: 'https://vkvideo.ru/video-222534261_456240753?list=ln-cX7y1TY0FmFwqMTUhQ',
  yt: 'https://youtu.be/Ph7uJ1RAZbU?si=YDp7eR44_xU2KQ8b',
  rt: 'https://rutube.ru/video/7d2a39deba78c2b57534ab65a6fd89e7/?r=a/'
};
  /* ====== Layout ====== */
function section(id, html){ return `<section class="slide" id="${id}">${html}</section>` }

const html=
+section('intro',`
  <div class="hero">
    <div class="card">
      <div class="inline-opts">
        <div class="opt is">Квиз с расчётом</div>
        <div class="opt">Программа старта</div>
        <div class="opt">Пробная тренировка</div>
      </div>
    </div>
    <div class="hero-img">
      <img src="superfit.png" alt="Шагательные тренировки дома">
    </div>
    <p class="hint">Отвечайте честно — так рекомендации будут точнее. Средняя длительность: 2–3 минуты.</p>
  </div>
`)
+section('goal',`
  <h2>Ваша цель</h2>
  <p class="sub">Выберите, чего хотите добиться</p>
  <div class="answer-opts" id="goalChips">
    <div class="chip" data-v="keep"><span class="dot"></span><span>Поддерживать форму</span></div>
    <div class="chip" data-v="slim"><span class="dot"></span><span>Похудеть</span></div>
    <div class="chip" data-v="energy"><span class="dot"></span><span>Больше энергии и лёгкости</span></div>
  </div>
  <div id="goalMore" class="hidden">
    <div class="kg">
      <input id="goalKg" type="number" inputmode="numeric" min="1" max="40" placeholder="Сколько кг хотите сбросить?">
      <span class="badge"><span>цель</span><b>-<span id="kgVal">0</span> кг</b></span>
    </div>
    <p class="hint">Мы считаем безопасный темп снижения веса — плавно, без «качелей».</p>
  </div>
`)
+section('perweek',`
  <h2>Сколько готовы заниматься в неделю?</h2>
  <p class="sub">Выберите подходящий график</p>
  <div class="answer-opts grid" id="pwChips">
    <div class="chip"><span class="dot"></span><span>2&nbsp;тренировки в неделю</span></div>
    <div class="chip"><span class="dot"></span><span>3&nbsp;тренировки в неделю</span></div>
    <div class="chip"><span class="dot"></span><span>4&nbsp;тренировки в неделю</span></div>
    <div class="chip"><span class="dot"></span><span>5&nbsp;тренировок в неделю</span></div>
  </div>
  <p class="hint" id="pwAha"></p>
`)
+section('age',`
  <h2>Возраст</h2>
  <p class="sub">Нужен для корректного темпа</p>
  <div class="answer-opts" id="ageOpts">
    <div class="chip"><span class="dot"></span><span>до 30</span></div>
    <div class="chip"><span class="dot"></span><span>30–39</span></div>
    <div class="chip"><span class="dot"></span><span>40–49</span></div>
    <div class="chip"><span class="dot"></span><span>50+</span></div>
  </div>
`)
+section('body',`
  <h2>Телосложение</h2>
  <div class="answer-opts" id="bodyOpts">
    <div class="chip"><img src="m.png" alt=""><span>Среднее</span></div>
    <div class="chip"><img src="xxl.png" alt=""><span>Полное</span></div>
  </div>
`)
+section('life',`
  <h2>Ваш образ жизни</h2>
  <div class="answer-opts" id="lifeOpts">
    <div class="chip"><span class="dot"></span><span>Сидячая работа</span></div>
    <div class="chip"><span class="dot"></span><span>Много активности</span></div>
    <div class="chip"><span class="dot"></span><span>Дом и дети</span></div>
    <div class="chip"><span class="dot"></span><span>Смена/строительство</span></div>
  </div>
`)
+section('exp',`
  <h2>Опыт в спорте</h2>
  <div class="answer-opts" id="expOpts">
    <div class="chip"><span class="dot"></span><span>Никогда не занималась</span></div>
    <div class="chip"><span class="dot"></span><span>Редко/от случая к случаю</span></div>
    <div class="chip"><span class="dot"></span><span>Регулярно тренируюсь</span></div>
  </div>
`)
+section('mot',`
  <h2>Что даётся тяжелее всего?</h2>
  <div class="answer-opts" id="motChips">
    <div class="chip"><span class="dot"></span><span>Инертность/нет сил</span></div>
    <div class="chip"><span class="dot"></span><span>Прыжки и высокие темпы</span></div>
    <div class="chip"><span class="dot"></span><span>Суставы/колени</span></div>
    <div class="chip"><span class="dot"></span><span>Одышка</span></div>
  </div>
  <p class="hint">Это поможет точно подобрать программу старта.</p>
`)
+section('habits',`
  <h2>Питание и привычки</h2>
  <p class="sub">Выбирайте то, что встречается чаще</p>

  <grid-2>
    <div class="card">
      <b>Негативные факторы</b>
      <div class="answer-opts" id="bad">
        <div class="chip"><span class="dot"></span><span>Переедаю вечером</span></div>
        <div class="chip"><span class="dot"></span><span>Мало воды</span></div>
        <div class="chip"><span class="dot"></span><span>Сладкое/выпечка</span></div>
        <div class="chip"><span class="dot"></span><span>Фастфуд/перекусы</span></div>
      </div>
    </div>
    <div class="card">
      <b>Полезные привычки</b>
      <div class="answer-opts" id="good">
        <div class="chip"><span class="dot"></span><span>Завтрак</span></div>
        <div class="chip"><span class="dot"></span><span>Овощи и белок</span></div>
        <div class="chip"><span class="dot"></span><span>Вода 1.5–2 л</span></div>
        <div class="chip"><span class="dot"></span><span>Шаги 6–8к</span></div>
      </div>
    </div>
  </grid-2>

  <hr class="sep"/>

  <b>Питаться проще по…</b>
  <div class="answer-opts" id="nutriOpts">
    <div class="chip"><span class="dot"></span><span>Готовому меню</span></div>
    <div class="chip"><span class="dot"></span><span>Простым правилам</span></div>
  </div>

  <div id="hmWrap" class="hidden">
    <div class="sub" style="display:flex;align-items:center;gap:10px">
      <span id="hmBadge" class="badge"><span>индекс питания</span> <b id="hmScore">0</b></span>
      <span id="hmMsg"></span>
    </div>
    <div class="progress"><i id="hmTrack" style="width:50%"></i></div>
  </div>
`)
+section('trial',`
  <h2>Пробная тренировка</h2>
  <p class="sub" id="trialCtaText">Попробуйте программу на себе — без регистрации</p>

  <div class="video-tabs" id="vTabs">
    <div class="tab is" data-k="vk">VK Видео</div>
    <div class="tab" data-k="yt">YouTube</div>
    <div class="tab" data-k="rt">RuTube</div>
  </div>

  <div class="video-embed" id="vWrap">
    <div class="ph">Загрузка видео…</div>
  </div>

  <div class="actions">
    <button class="btn ghost" data-prev>Назад</button>
    <button class="btn primary" id="toCTA">Посмотреть результат</button>
  </div>
`)
  +section('result',`
  <h2>Ваш прогноз</h2>
  <p class="sub">Безопасный темп снижения веса — без жёстких диет и «качелей»</p>

  <div class="hero card" id="resHero">
    <div class="inline-opts">
      <span class="badge"><span>темп</span> <b id="paceBadge">–</b></span>
      <span class="badge"><span>недель</span> <b id="weeksBadge">–</b></span>
      <span class="badge"><span>график</span> <b id="pwBadge">–</b></span>
    </div>
    <p id="resLead"></p>
  </div>

  <div class="actions">
    <button class="btn ghost" id="toPrograms">Посмотреть программу</button>
    <button class="btn primary" id="toCTA">Перейти к предложению</button>
  </div>
`)
+section('program',`
  <div class="prog-wrap">
    <div class="prog-head">
      <div class="p-title" id="progTitle">Мы рекомендуем вам…</div>
      <p class="p-sub" id="progLead"></p>
      <div class="p-chips" id="progChips"></div>
    </div>

    <figure class="prog-hero">
      <img src="program.png" alt="Рекомендуемая программа в клубе">
    </figure>

    <div class="prog-card">
      <h3>Почему это подойдёт именно вам</h3>
      <ul class="prog-list" id="progList"></ul>
    </div>

    <div class="actions sticky">
      <button class="btn ghost" data-prev>Назад</button>
      <button class="btn primary" id="toSale">К абонементам →</button>
    </div>
  </div>
`)
+section('sale',`
  <h2>Абонементы клуба</h2>
  <p class="sub">Все абонементы включают доступ к 28 программам и новым треням</p>

  <div class="inline-opts">
    <span class="badge"><span>скидка</span> <b id="saleBadge">–70%</b></span>
    <span class="badge"><span>таймер</span> <b id="timerBadge">15:00</b></span>
  </div>

  <div class="hero card">
    <ul style="margin:8px 0 0 18px">
      <li>Доступ к 28 программам и 400+ тренировкам</li>
      <li>Пробные занятия и разогревы</li>
      <li>Питание: готовые меню и «тарелка где угодно»</li>
    </ul>
  </div>

  <grid-2>
    <div class="card">
      <b>1 месяц</b>
      <div class="sub">Стартовый абонемент</div>
      <h3 id="p1">990 ₽</h3>
      <button class="btn primary wide">Купить</button>
    </div>
    <div class="card">
      <b>3 месяца</b>
      <div class="sub">Самый выгодный</div>
      <h3 id="p3">2490 ₽</h3>
      <button class="btn primary wide">Купить</button>
    </div>
  </grid-2>

  <div class="actions">
    <button class="btn ghost" data-prev>Назад</button>
    <button class="btn primary" id="toPay">Оплатить</button>
  </div>
`)
;

document.getElementById('screens').innerHTML=html;

/* ====== Flow ====== */
const slides = $$('#screens .slide');
let idx = 0;
function show(i){
  idx=i;
  slides.forEach((s,k)=>s.style.display=(i===k)?'grid':'none');
  $('#progbar').style.width = ((i)/(slides.length-1))*100 + '%';
  window.scrollTo({top:0, behavior:'smooth'})
}
function idxBy(id){ return slides.findIndex(s=>s.id===id) }
show(0);

/* ====== Inputs & Selections ====== */
function perweekLabel(){
  const v=A.perweek; if(!v) return '2–4 раза в неделю';
  if(Array.isArray(v)){ if(v.length===1) return v[0]; return v.join(', ') }
  return v;
}
function goalKg(){ const el=$('#goalKg'); return el?Number(el.value||0):0 }

function selectList(root,key, single=false){
  if(!root) return;
  root.addEventListener('click', e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    if(single){ $$('.chip',root).forEach(c=>c.classList.remove('is')); chip.classList.add('is'); A[key]=chip.dataset.v||chip.textContent.trim(); }
    else { chip.classList.toggle('is'); A[key]=$$('.chip.is',root).map(x=>x.dataset.v||x.textContent.trim()) }
    if(root.id==='goalChips'){
      A.keep = A.keep || (Array.isArray(A.keep)?A.keep.includes('keep'):false);
      const t=$$('.chip.is',root).map(c=>c.dataset.v||c.textContent.trim());
      A.keep = t.includes('keep');
      $('#goalMore').classList.toggle('hidden', !t.includes('slim'));
    }
    if(root.id==='pwChips'){ updateAha() }
    if(root.id==='bad'||root.id==='good') setTimeout(updMeter,0);
    save(); vibrate(8);
  });
}
selectList($('#goalChips'),'goal',false);
selectList($('#pwChips'),'perweek',false);
selectList($('#ageOpts'),'age',true);
selectList($('#bodyOpts'),'body',true);
selectList($('#lifeOpts'),'life',true);
selectList($('#expOpts'),'exp',true);
selectList($('#motChips'),'mot',false);
selectList($('#nutriOpts'),'nutri',true);

const kgInput=$('#goalKg'); if(kgInput){
  kgInput.addEventListener('input',()=>{ $('#kgVal').textContent=kgInput.value||0; save() });
}
function updateAha(){
  const el=$('#pwAha'); if(!el) return;
  const v=A.perweek||[];
  let txt='Оптимально 3–4 тренировки в неделю. При 2 — сроки чуть дольше, при 5 — можно чередовать «мягкие» и интенсивные.';
  if(Array.isArray(v) && v.includes('5 тренировок в неделю')) txt='При 5 тренировках — важен баланс: чередуем «мягкие» и более интенсивные, слушаем тело.';
  if(Array.isArray(v) && v.includes('2 тренировки в неделю')) txt='При 2 тренировках сроки увеличатся — но прогресс будет, если добавить шаги и питание.';
  el.textContent=txt;
}
updateAha();
  /* habits meter */
function nutrPreview(){
  const b=(A.bad||[]).length, g=(A.good||[]).length;
  let f=1; f+=g*.02; f-=b*.03;
  return Math.max(.7,Math.min(1.35,f))
}
function updMeter(){
  const b=(A.bad||[]).length,g=(A.good||[]).length, any=b+g>0;
  var wrap=$('#hmWrap'); if(wrap){wrap.classList.toggle('hidden',!any)}
  if(!any) return;
  const f=nutrPreview(),acc=Math.round((f-1)*100);
  const ptr=$('#hmPtr'),track=$('#hmTrack'),score=$('#hmScore'),badge=$('#hmBadge');
  const min=-30,max=35,clamp=Math.max(min,Math.min(max,acc)),p=((clamp-min)/(max-min))*100;
  if(track) track.style.width=p+'%';
  if(score) score.textContent = (acc>0?'+':'')+acc+'%';
  if(badge) badge.style.borderColor = acc>=0?'#cfeede':'#ffd5c2';
  const msg=$('#hmMsg');
  if(msg){
    if(acc>=12) msg.textContent='Питание помогает ускорить прогресс';
    else if(acc>=0) msg.textContent='Неплохо! Можно усилить за счёт воды и белка';
    else msg.textContent='Питание замедляет прогресс — но тренировки всё равно дадут результат';
  }
}
setTimeout(updMeter,0);

/* Trial embed logic */
function renderTrial(k){
  const url = TRIAL_EMBEDS[k]||TRIAL_EMBEDS.vk;
  const host = k==='vk' ? 'vkvideo.ru' : k==='yt' ? 'youtube.com' : 'rutube.ru';
  let iframe = '';
  if(k==='vk'){
    iframe = `<iframe src="${url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  }else if(k==='yt'){
    const idMatch = /youtu\.be\/([A-Za-z0-9_-]+)/.exec(url) || /v=([A-Za-z0-9_-]+)/.exec(url);
    const id = idMatch ? idMatch[1] : '';
    iframe = `<iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  }else{
    iframe = `<iframe src="${url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  }
  $('#vWrap').innerHTML = iframe;
}
renderTrial('vk');
$('#vTabs').addEventListener('click', e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('.tab','#vTabs').forEach(x=>x.classList.remove('is'));
  t.classList.add('is');
  renderTrial(t.dataset.k);
  vibrate(6);
});
function updateTrialCtaText(){
  var el=$('#trialCtaText'); if(!el) return;
  el.innerHTML='<b>Узнайте, на сколько вы похудеете, если будете заниматься по таким тренировкам '+perweekLabel()+'.</b>';
}

/* Result calc */
function calculate(){
  const kg = goalKg();
  const base = Math.max(kg/0.5, 4); // ~0.5 кг/неделя безопасно
  let weeks = base;
  if(Array.isArray(A.perweek)){
    if(A.perweek.includes('4 тренировки в неделю')) weeks-=1;
    if(A.perweek.includes('5 тренировок в неделю')) weeks-=1;
    if(A.perweek.includes('2 тренировки в неделю')) weeks+=1;
  }
  const f = nutrPreview();
  weeks = Math.max(4, Math.round(weeks / (f>1?1.1:1)));
  $('#weeksBadge').textContent = weeks.toString();

  let pace = 'плавный';
  if(weeks<=6) pace='быстрый';
  if(weeks>=12) pace='плавный, с упором на привычки';
  $('#paceBadge').textContent = pace;

  $('#pwBadge').textContent = Array.isArray(A.perweek)?A.perweek.join(', '): (A.perweek||'2–4 раза/нед');

  const lead = [];
  if(kg>0) lead.push(`Двигаемся к цели −${kg} кг без изнурения.`);
  if(/Сидячая/.test(A.life||'')) lead.push('Будем мягко разгонять обмен и уходить от «сидячих» болей.');
  if(/Никогда/.test(A.exp||'')) lead.push('Подробные подсказки тренера — начнёте уверенно.');
  if(A.steps) lead.push(`Ваш уровень шагов учтём — и добавим постепенно (сейчас ~${(+A.steps).toLocaleString('ru-RU')}).`);
  $('#resLead').textContent = lead.join(' ');
}

/* === Program recommendation === */
function chooseProgram(){
  const bmi = Number(A.bmi||0);
  const exp = A.exp||'';
  const life= A.life||'';
  const hard= A.hardKey||'';
  const keep = !!A.keep;

  let p={title:'SOFT START',lead:'Мягкий вход в тренировки без прыжков и перегруза.',meta:{workouts:'3 тренировки/нед',duration:'20–25 мин',tempo:'низкий'}};
  if (/Регулярно/.test(exp) || /Активная/.test(life)) p={title:'BALANCE',lead:'Силовая и шагательная нагрузка в комфортном темпе.',meta:{workouts:'4 тренировки/нед',duration:'25–30 мин',tempo:'средний'}};
  if (bmi>=30 || /jumps|stairs|walk/.test(hard)) p={title:'SOFT',lead:'Щадящая нагрузка для суставов, без прыжков.',meta:{workouts:'3 тренировки/нед',duration:'15–20 мин',tempo:'низкий'}};
  if (keep) p={title:'TONUS',lead:'Поддержание тонуса, осанки и энергии.',meta:{workouts:'3–4 тренировки/нед',duration:'20–25 мин',tempo:'средний'}};

  if (/энерг|лёгк/i.test((A.mot||[]).join(' '))) p.meta.steps='добавим 6–8к шагов';
  return p;
}
function buildProgramBullets(p){
  const B=[], kg=+goalKg()||0;
  if (A.keep || kg===0) B.push('Делаем акцент на тонус, выносливость и лёгкость в теле.');
  else B.push('Двигаемся к вашей цели −'+kg+' кг без рывков и изнурения.');
  if (/Сидячая/.test(A.life||'')) B.push('Мягко разгоняем обмен и уходим от «сидячих» болей.');
  if (/Никогда/.test(A.exp||'')) B.push('Подробные подсказки тренера — начнёте уверенно.');
  if (A.perweek) B.push('Оптимальный график: '+(Array.isArray(A.perweek)?A.perweek.join(', '):A.perweek)+'.');
  if (A.steps) B.push('Подхватим ваш уровень шагов и увеличим постепенно (сейчас ~'+(+A.steps).toLocaleString('ru-RU')+').');
  return B.slice(0,7);
}
function renderProgram(){
  const p=chooseProgram();
  const title = `У нас 28 программ, но вам лучше начать с «${p.title}». Входит в любой абонемент!`;
  const leadParts=[p.lead];
  if(/Активная/.test(A.life||'')||/Регулярно/.test(A.exp||'')) leadParts.push('Подойдёт, если любите чуть выше темп.');
  if(/Сидячая/.test(A.life||'')) leadParts.push('Если много сидите — вернём подвижность мягко.');

  const chips=[];
  if (p.meta?.workouts) chips.push(p.meta.workouts);
  if (p.meta?.duration) chips.push(p.meta.duration);
  if (p.meta?.steps)    chips.push(p.meta.steps);
  if (p.meta?.tempo)    chips.push(p.meta.tempo);
  const chipsHtml = chips.map(t=>`<span class="p-chip${/высокий|средний/i.test(t)?' emph':''}">${t}</span>`).join('');

  const tEl=document.getElementById('progTitle');
  const lEl=document.getElementById('progLead');
  const cEl=document.getElementById('progChips');
  const ul =document.getElementById('progList');

  if (tEl) tEl.textContent = title;
  if (lEl) lEl.textContent = leadParts.join(' ');
  if (cEl) cEl.innerHTML   = chipsHtml;

  if (ul){
    ul.innerHTML='';
    buildProgramBullets(p).forEach(b=>{
      const li=document.createElement('li');
      li.textContent=b;
      ul.appendChild(li);
    });
  }
}
  /* ===== Timers (15 минут) ===== */
let SALE_END = null, TID=null;
function startTimers(){
  if(SALE_END && SALE_END > Date.now()) return;
  SALE_END = Date.now() + 15*60*1000;
  tick();
  if(TID) clearInterval(TID);
  TID=setInterval(tick,1000);
}
function tick(){
  const left = Math.max(0, SALE_END - Date.now());
  const mm = String(Math.floor(left/60000)).padStart(2,'0');
  const ss = String(Math.floor((left%60000)/1000)).padStart(2,'0');
  $('#timerBadge').textContent = `${mm}:${ss}`;
  if(left===0 && TID){ clearInterval(TID); }
}
function layoutSaleOffer(){
  // Здесь можно динамически менять цены/скидки
  $('#saleBadge').textContent='–70%';
  $('#p1').textContent='990 ₽';
  $('#p3').textContent='2490 ₽';
}

/* ===== Navigation & Events ===== */
const screensRoot = $('#screens');
const nextBtn = $('#next');

function next(){
  if(idx < slides.length-1){
    show(idx+1);
  }
}
nextBtn.addEventListener('click', next);

screensRoot.addEventListener('click', function(e){
  // prev
  if(e.target.closest('[data-prev]')){ e.preventDefault(); if(idx>0) show(idx-1); }

  // RESULT → Program
  if (e.target.closest('#toCTA')) { e.preventDefault(); try{renderProgram()}catch(_){} show(idxBy('program')); }

  // Program → Sale
  if (e.target.closest('#toSale')) { e.preventDefault(); show(idxBy('sale')); try{layoutSaleOffer(); startTimers();}catch(_){ } }

  // to Pay (stub)
  if(e.target.closest('#toPay')){ e.preventDefault(); alert('Переход к оплате…'); }
});

/* ===== Progress ===== */
function setProgress(){
  const visible = slides.findIndex(s=>s.style.display!=='none');
  const p = Math.max(0, visible) / (slides.length-1) * 100;
  $('#progbar').style.width = p + '%';
}
setInterval(setProgress,300);

/* Recalc on entering result */
const __show=show;
show=function(i){ __show(i); if(slides[i].id==='result'){ calculate(); updateTrialCtaText(); } };

/* ====== Prefill from saved ====== */
(function hydrate(){
  if(A.goal==='slim'){ $('#goalMore').classList.remove('hidden'); }
  if(A.perweek){ (Array.isArray(A.perweek)?A.perweek:[A.perweek]).forEach(v=>{
    $$('#pwChips .chip').forEach(c=>{ if(c.textContent.trim()===v) c.classList.add('is') })
  })}
  if(A.age){ $$('#ageOpts .chip').forEach(c=>{ if(c.textContent.trim()===A.age) c.classList.add('is') }) }
  if(A.body){ $$('#bodyOpts .chip').forEach(c=>{ if(c.textContent.trim()===A.body) c.classList.add('is') }) }
  if(A.life){ $$('#lifeOpts .chip').forEach(c=>{ if(c.textContent.trim()===A.life) c.classList.add('is') }) }
  if(A.exp){ $$('#expOpts .chip').forEach(c=>{ if(c.textContent.trim()===A.exp) c.classList.add('is') }) }
  if(A.mot){ $$('#motChips .chip').forEach(c=>{ if((A.mot||[]).includes(c.textContent.trim())) c.classList.add('is') }) }
  if(A.good){ $$('#good .chip').forEach(c=>{ if((A.good||[]).includes(c.textContent.trim())) c.classList.add('is') }) }
  if(A.bad){ $$('#bad .chip').forEach(c=>{ if((A.bad||[]).includes(c.textContent.trim())) c.classList.add('is') }) }
  if(A.nutri){ $$('#nutriOpts .chip').forEach(c=>{ if(c.textContent.trim()===A.nutri) c.classList.add('is') }) }
  if($('#goalKg') && A.goal==='slim'){ $('#goalKg').value = A.goalKg||''; $('#kgVal').textContent = A.goalKg||0 }
  setTimeout(updMeter,0);
})();
  /* ====== Screen-specific hooks ====== */
function wire(){
  // goal
  const kg=$('#goalKg');
  if(kg) kg.addEventListener('input', ()=>{ A.goalKg=kg.value; save() });

  // simple selects
  function bind(root,key,single){
    if(!root) return;
    root.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      if(single){ $$('.chip',root).forEach(c=>c.classList.remove('is')); chip.classList.add('is'); A[key]=chip.textContent.trim() }
      else{ chip.classList.toggle('is'); A[key]=$$('.chip.is',root).map(x=>x.textContent.trim()) }
      save(); vibrate(8);
      if(root.id==='bad'||root.id==='good') setTimeout(updMeter,0);
      if(root.id==='pwChips') updateAha();
    });
  }
  bind($('#ageOpts'),'age',true);
  bind($('#bodyOpts'),'body',true);
  bind($('#lifeOpts'),'life',true);
  bind($('#expOpts'),'exp',true);
  bind($('#motChips'),'mot',false);
  bind($('#pwChips'),'perweek',false);
  bind($('#healthChips'),'health',false);
  bind($('#bad'),'bad',false);
  bind($('#good'),'good',false);
  bind($('#nutriOpts'),'nutri',true);
}
wire();

/* Quality-of-life */
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight') next();
  if(e.key==='ArrowLeft' && idx>0) show(idx-1);
});

/* ===== Helpers for texts ===== */
function perweekShort(){
  if(!A.perweek) return '2–4 р/нед';
  if(Array.isArray(A.perweek)){
    if(A.perweek.length===1) return A.perweek[0].replace('тренировок ','р/').replace('тренировки ','р/');
    return A.perweek.length+' р/нед';
  }
  return A.perweek.replace('тренировок ','р/').replace('тренировки ','р/');
}

/* Additional texts */
function updateResultLead(){
  const lead = [];
  const kg=+goalKg()||0;
  if(kg>0) lead.push(`Идём к цели −${kg} кг, шаг за шагом.`);
  if(/Сидячая/.test(A.life||'')) lead.push('Добавим «мягкие» разогревы для спины и плеч.');
  if(/Никогда/.test(A.exp||'')) lead.push('Начнёте с простых связок без прыжков.');
  $('#resLead').textContent = lead.join(' ');
  }
  /* After trial → result we also start timers on sale later */
function goToSale(){
  show(idxBy('sale'));
  layoutSaleOffer();
  startTimers();
}

/* ====== End ====== */
</script>
</body>
</html>
